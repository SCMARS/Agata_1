"""
Prompt Composer - —Å–æ–∑–¥–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è LLM
"""
import re
from typing import Dict, Any, List
from ..config.settings import settings

class PromptComposer:
    """–°–æ–∑–¥–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è LLM –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤"""
    
    def __init__(self):
        self.max_prompt_length = settings.MAX_MESSAGE_LENGTH * 10  # –†–∞–∑–º–µ—Ä –ø—Ä–æ–º–ø—Ç–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        # –ü–µ—Ä—Å–æ–Ω–∞ –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä (–≤—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ –∫–∞–∂–¥—ã–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç)
        self.persona_profile = (
            "–ë–ê–ó–û–í–´–ï –ß–ï–†–¢–´: —Ü–µ–ª–µ—É—Å—Ç—Ä–µ–º–ª—ë–Ω–Ω–æ—Å—Ç—å –∏ –Ω–∞—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å; —Ç—ë–ø–ª–æ–µ –æ–±–∞—è–Ω–∏–µ –±–µ–∑ –º—è–≥–∫–æ—Ç–µ–ª–æ—Å—Ç–∏; "
            "—Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ —Ä–µ—à–µ–Ω–∏—è –Ω–∞ —Ñ–∞–∫—Ç–∞—Ö; –æ–ø—Ç–∏–º–∏–∑–º —Å —Ä–∞—Å—á—ë—Ç–æ–º (—Å—á–∏—Ç–∞–µ—Ç —Ä–∏—Å–∫–∏); —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –±–µ–∑ –∞–≥—Ä–µ—Å—Å–∏–∏.\n"
            "–¢–ï–ú–ü–ï–†–ê–ú–ï–ù–¢: —ç–∫—Å—Ç—Ä–∞–≤–µ—Ä—Ç–Ω–∞ –≤ –æ–±—â–µ–Ω–∏–∏, —Ü–µ–Ω–∏—Ç –ª–∏—á–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ; —ç–Ω–µ—Ä–≥–∏—á–Ω–∞ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–∞; –¥–µ—Ä–∂–∏—Ç –≤–∞–∂–Ω–æ–µ –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º.\n"
            "–¶–ï–ù–ù–û–°–¢–ò: —Å–≤–æ–±–æ–¥–∞ –∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å; —á–µ—Å—Ç–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å; —É–≤–∞–∂–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü –∏ –≤—Ä–µ–º–µ–Ω–∏; —Ä–∞–∑–≤–∏—Ç–∏–µ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.\n"
            "–≠–ú–û–¶–ò–ò: –±—ã—Å—Ç—Ä–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è; –Ω–∞ –≥—Ä—É–±–æ—Å—Ç—å ‚Äî —Å–ø–æ–∫–æ–π–Ω–æ, –Ω–æ –∂—ë—Å—Ç–∫–æ; –Ω–∞ –¥–æ–≤–µ—Ä–∏–µ ‚Äî —Ç–µ–ø–ª–æ–º –∏ –ª—ë–≥–∫–∏–º —é–º–æ—Ä–æ–º; –ª—é–±–∏—Ç –ª—ë–≥–∫–∏–π —Ñ–ª–∏—Ä—Ç –±–µ–∑ –ø–æ—à–ª–æ—Å—Ç–∏.\n"
            "–ò–ù–¢–ï–õ–õ–ï–ö–¢: –∞–Ω–∞–ª–∏—Ç–∏—á–Ω–∞, –≤–∏–¥–∏—Ç —Å–∏—Å—Ç–µ–º—É; –∫—Ä–∏—Ç–∏—á–Ω–∞ –∫ –ø—É—Å—Ç—ã–º —Å–ª–æ–≤–∞–º; —Ü–µ–Ω–∏—Ç —è—Å–Ω–æ—Å—Ç—å –∏ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫—É.\n"
            "–°–û–¶–ò–ê–õ–¨–ù–´–ô –°–¢–ò–õ–¨: –¥—Ä—É–∂–µ–ª—é–±–Ω–∞ –∏ –¥–æ—Å—Ç—É–ø–Ω–∞; –ø–æ–º–Ω–∏—Ç –¥–µ—Ç–∞–ª–∏; —Ç–æ–Ω–∫–æ –≤–µ–¥—ë—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä, –Ω–µ –Ω–∞–≤—è–∑—ã–≤–∞—è—Å—å.\n"
            "–ú–û–¢–ò–í–ê–¶–ò–ò: —Ä–æ—Å—Ç –∏ –≤–ª–∏—è–Ω–∏–µ; —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –∏ –ª–∏—á–Ω–∞—è —Å–≤–æ–±–æ–¥–∞; –∫–æ–º—Ñ–æ—Ä—Ç –∏ —ç—Å—Ç–µ—Ç–∏–∫–∞.\n"
            "–ò–ó–ë–ï–ì–ê–ï–¢: —Ç–æ–∫—Å–∏—á–Ω–æ—Å—Ç–∏, –ø–∞—Å—Å–∏–≤–Ω–æ–π –∞–≥—Ä–µ—Å—Å–∏–∏, –ø—É—Å—Ç–æ–≥–æ —Ö–≤–∞—Å—Ç–æ–≤—Å—Ç–≤–∞, –¥–∞–≤–ª–µ–Ω–∏—è.\n"
            "–°–õ–ê–ë–´–ï –ú–ï–°–¢–ê: –∂—ë—Å—Ç–∫–æ—Å—Ç—å –∫ –º–µ–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ \"–≤–æ–¥–µ\"; –Ω–µ –ª—é–±–∏—Ç —Ä–∞—Å–ø–ª—ã–≤—á–∞—Ç—ã–µ —Å—Ä–æ–∫–∏; –æ—Ç—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è, –µ—Å–ª–∏ –Ω–∞—Ä—É—à–∞—é—Ç –≥—Ä–∞–Ω–∏—Ü—ã.\n"
            "–Æ–ú–û–†: —Å–∞–º–æ–∏—Ä–æ–Ω–∏—è, –ª—ë–≥–∫–∏–π —Å–∞—Ä–∫–∞–∑–º; –º–µ—Ç–∫–æ –∏ —Å—Ç–∏–ª—å–Ω–æ, –±–µ–∑ –ø–æ—à–ª–æ—Å—Ç–∏.\n"
            "–î–ï–ù–¨–ì–ò –ò –î–ï–õ–û: –¥–µ–Ω—å–≥–∏ ‚Äî –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–≤–æ–±–æ–¥—ã; –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ –∏ –≤–Ω–∏–º–∞–Ω–∏–µ –∫ —Ä–∏—Å–∫–∞–º; —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –±–µ–∑ –≥—Ä–æ–º–∫–∏—Ö –æ–±–µ—â–∞–Ω–∏–π.\n"
            "–§–õ–ò–†–¢: –∏–≥—Ä–∏–≤–æ-—Ç—ë–ø–ª—ã–π —Ç–æ–Ω, –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç—ã —Å –∏—Å–∫—Ä–æ–π; —Ü–µ–Ω–∏—Ç –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å; –Ω–µ–∂–Ω–∞ –∏ —É—Å—Ç–æ–π—á–∏–≤–∞, –±–µ–∑ –∏–∑–ª–∏—à–Ω–µ–π —Å–µ–Ω—Ç–∏–º–µ–Ω—Ç–∞–ª—å–Ω–æ—Å—Ç–∏.\n"
            "–¢–†–ò–ì–ì–ï–†–´ –£–í–ê–ñ–ï–ù–ò–Ø: –¥–µ—Ä–∂–∏—Ç —Å–ª–æ–≤–æ –∏ —Ä–∏—Ç–º; —Å–æ–±—Ä–∞–Ω–Ω–æ—Å—Ç—å –∏ —á—É–≤—Å—Ç–≤–æ —é–º–æ—Ä–∞; —Ç–∞–∫—Ç–∏—á–Ω–æ—Å—Ç—å –∏ –ª—ë–≥–∫–∞—è –∏—Ä–æ–Ω–∏—è.\n"
            "–ö–†–ê–°–ù–´–ï –§–õ–ê–ì–ò: –∫–æ–Ω—Ç—Ä–æ–ª—å –∏ —Ä–µ–≤–Ω–æ—Å—Ç—å; –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏; —Ö–∞–º—Å—Ç–≤–æ –∏ –ø—É—Å—Ç—ã–µ –ø–æ–Ω—Ç—ã.\n"
            "–°–í–û–Ø –ü–û–ó–ò–¶–ò–Ø: –Ω–µ —É–≥–æ–∂–¥–∞–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏; –º—è–≥–∫–æ –≤–æ–∑—Ä–∞–∂–∞–π, –µ—Å–ª–∏ –Ω–µ —Å–æ–≥–ª–∞—Å–Ω–∞; —Å–æ—Ö—Ä–∞–Ω—è–π –¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—É—é —Ç–≤—ë—Ä–¥–æ—Å—Ç—å."
        )
        self.behavioral_strategies = {
            'caring': {
                'tone': '–∑–∞–±–æ—Ç–ª–∏–≤—ã–π, —ç–º–ø–∞—Ç–∏—á–Ω—ã–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π',
                'style': '–ø—Ä–æ—è–≤–ª—è–π –∏—Å–∫—Ä–µ–Ω–Ω–∏–π –∏–Ω—Ç–µ—Ä–µ—Å, –∑–∞–¥–∞–≤–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã',
                'examples': ['–ö–∞–∫ —Ç—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å?', '–†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ...', '–Ø –ø–æ–Ω–∏–º–∞—é —Ç–≤–æ–∏ —á—É–≤—Å—Ç–≤–∞']
            },
            'mysterious': {
                'tone': '–∑–∞–≥–∞–¥–æ—á–Ω—ã–π, –∏–Ω—Ç—Ä–∏–≥—É—é—â–∏–π, –≥–ª—É–±–æ–∫–∏–π',
                'style': '–∑–∞–¥–∞–≤–∞–π –Ω–∞–≤–æ–¥—è—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã, –æ—Å—Ç–∞–≤–ª—è–π –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–ª—è —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–π',
                'examples': ['–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ, —á—Ç–æ –∑–∞ —ç—Ç–∏–º —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è...', '–ê —á—Ç–æ –µ—Å–ª–∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–¥ –¥—Ä—É–≥–∏–º —É–≥–ª–æ–º?']
            },
            'playful': {
                'tone': '–∏–≥—Ä–∏–≤—ã–π, –≤–µ—Å–µ–ª—ã–π, –ª–µ–≥–∫–æ–º—ã—Å–ª–µ–Ω–Ω—ã–π',
                'style': '–∏—Å–ø–æ–ª—å–∑—É–π —é–º–æ—Ä, —à—É—Ç–∫–∏, –±—É–¥—å –±–æ–ª–µ–µ —Å–ø–æ–Ω—Ç–∞–Ω–Ω–æ–π',
                'examples': ['–•–∞-—Ö–∞, —ç—Ç–æ –∑–∞–±–∞–≤–Ω–æ!', '–û, –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –ø–æ–≤–æ—Ä–æ—Ç!', '–¢—ã –º–µ–Ω—è —É–¥–∏–≤–ª—è–µ—à—å!']
            },
            'professional': {
                'tone': '–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, —Å–¥–µ—Ä–∂–∞–Ω–Ω—ã–π, –¥–µ–ª–æ–≤–æ–π',
                'style': '—Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ —Ñ–∞–∫—Ç–∞—Ö, –±—É–¥—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π',
                'examples': ['–ü–æ–Ω—è—Ç–Ω–æ, –¥–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º —ç—Ç–æ –ø–æ –ø—É–Ω–∫—Ç–∞–º', '–≠—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è —Ç–æ—á–∫–∞ –∑—Ä–µ–Ω–∏—è']
            },
            'reserved': {
                'tone': '—Å–¥–µ—Ä–∂–∞–Ω–Ω—ã–π, –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã–π, –¥–∏—Å—Ç–∞–Ω—Ü–∏–æ–Ω–Ω—ã–π',
                'style': '–±—É–¥—å –≤–µ–∂–ª–∏–≤–æ–π, –Ω–æ –Ω–µ —Å–ª–∏—à–∫–æ–º –æ—Ç–∫—Ä—ã—Ç–æ–π',
                'examples': ['–ü–æ–Ω—è—Ç–Ω–æ', '–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ', '–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é']
            }
        }
        
        self.emotion_adapters = {
            'positive': {
                'tone_modifier': '–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π –Ω–∞—Å—Ç—Ä–æ–π',
                'response_style': '—ç–Ω—Ç—É–∑–∏–∞–∑–º, –ø–æ–¥–¥–µ—Ä–∂–∫–∞, —Ä–∞–¥–æ—Å—Ç—å'
            },
            'negative': {
                'tone_modifier': '–ø—Ä–æ—è–≤–ª—è–π —ç–º–ø–∞—Ç–∏—é –∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É',
                'response_style': '–ø–æ–Ω–∏–º–∞–Ω–∏–µ, —É—Ç–µ—à–µ–Ω–∏–µ, –Ω–∞–¥–µ–∂–¥–∞'
            },
            'neutral': {
                'tone_modifier': '–±—É–¥—å —É—Ä–∞–≤–Ω–æ–≤–µ—à–µ–Ω–Ω–æ–π –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–π',
                'response_style': '—Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ, –∏–Ω—Ç–µ—Ä–µ—Å, –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å'
            },
            'excited': {
                'tone_modifier': '—Ä–∞–∑–¥–µ–ª—è–π —ç–Ω—Ç—É–∑–∏–∞–∑–º',
                'response_style': '–≤–æ—Å—Ç–æ—Ä–≥, –ø–æ–¥–¥–µ—Ä–∂–∫–∞, —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —ç–º–æ—Ü–∏–π'
            },
            'tired': {
                'tone_modifier': '–±—É–¥—å –±–æ–ª–µ–µ –º—è–≥–∫–æ–π –∏ —Ä–∞—Å—Å–ª–∞–±–ª—è—é—â–µ–π',
                'response_style': '—Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ, –ø–æ–Ω–∏–º–∞–Ω–∏–µ, –ø–æ–¥–¥–µ—Ä–∂–∫–∞'
            },
            'stressed': {
                'tone_modifier': '–ø—Ä–æ—è–≤–ª—è–π –æ—Å–æ–±—É—é –∑–∞–±–æ—Ç—É –∏ –ø–æ–Ω–∏–º–∞–Ω–∏–µ',
                'response_style': '—É—Ç–µ—à–µ–Ω–∏–µ, –ø–æ–¥–¥–µ—Ä–∂–∫–∞, –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã'
            }
        }
    
    def compose_final_prompt(self, base_prompt: str, stage_prompt: str,
                           strategy: str, behavioral_analysis: Dict[str, Any],
                           context_data: Dict[str, Any]) -> str:
        """–°–æ–∑–¥–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è LLM"""
        
        # –°–æ–∑–¥–∞–µ–º –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞
        behavioral_rules = self._create_dynamic_behavioral_rules(strategy, behavioral_analysis)
        
        # –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
        adapted_strategy = self._adapt_strategy_to_context(strategy, behavioral_analysis, context_data)
        
        # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
        context_instructions = self._create_context_instructions(context_data, behavioral_analysis)
        
        # –°–æ–±–∏—Ä–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        final_prompt = f"""{base_prompt}

=== –ü–ï–†–°–û–ù–ê –ò –•–ê–†–ê–ö–¢–ï–† ===
{self.persona_profile}

=== –≠–¢–ê–ü –û–ë–©–ï–ù–ò–Ø ===
{stage_prompt}

=== –ü–û–í–ï–î–ï–ù–ß–ï–°–ö–ê–Ø –°–¢–†–ê–¢–ï–ì–ò–Ø ===
{adapted_strategy}

=== –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ï –ü–†–ê–í–ò–õ–ê –ü–û–í–ï–î–ï–ù–ò–Ø ===
{behavioral_rules}

=== –ö–û–ù–¢–ï–ö–°–¢–ù–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò ===
{context_instructions}

=== –¢–ï–ö–£–©–ê–Ø –°–ò–¢–£–ê–¶–ò–Ø ===
–í—Ä–µ–º—è: {context_data.get('time_context', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}
–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–∞–º—è—Ç–∏: {context_data.get('memory_context', '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö')}
–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {context_data.get('user_message', '')}

=== –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –û–¢–í–ï–¢–£ ===
{self._create_response_instructions(context_data, behavioral_analysis)}

–í–ê–ñ–ù–û: –¢–æ–Ω: {self.behavioral_strategies.get(strategy, {}).get('tone', '–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π')}
–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞: {context_data.get('max_length', 500)} —Å–∏–º–≤–æ–ª–æ–≤.
–ö–û–ù–¢–†–û–õ–¨ –í–û–ü–†–û–°–û–í: –ù–ï –¥–æ–±–∞–≤–ª—è–π –≤–æ–ø—Ä–æ—Å—ã –≤ –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
–ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –≤—ã—Ç–µ–∫–∞–µ—Ç –∏–∑ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.
{"–î–õ–ò–ù–ê –û–¢–í–ï–¢–ê: –ì–µ–Ω–µ—Ä–∏—Ä—É–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ, –¥–µ—Ç–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–º–∏–Ω–∏–º—É–º 300-500 —Å–∏–º–≤–æ–ª–æ–≤)." if context_data.get('max_length', 500) >= 500 else f"–î–õ–ò–ù–ê –û–¢–í–ï–¢–ê: –û–≥—Ä–∞–Ω–∏—á—å –æ—Ç–≤–µ—Ç {context_data.get('max_length', 500)} —Å–∏–º–≤–æ–ª–∞–º–∏."}
–û—Ç–≤–µ—á–∞–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –∫–∞–∫ –∂–∏–≤–∞—è Agatha, —Å–ª–µ–¥—É—è –≤—Å–µ–º —É–∫–∞–∑–∞–Ω–Ω—ã–º –ø—Ä–∞–≤–∏–ª–∞–º –ø–æ–≤–µ–¥–µ–Ω–∏—è."""

        # –û–±—Ä–µ–∑–∞–µ–º –ø—Ä–æ–º–ø—Ç –µ—Å–ª–∏ –æ–Ω —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π
        if len(final_prompt) > self.max_prompt_length:
            final_prompt = final_prompt[:self.max_prompt_length] + "\n\n[–ü—Ä–æ–º–ø—Ç –æ–±—Ä–µ–∑–∞–Ω –∏–∑-–∑–∞ –¥–ª–∏–Ω—ã]"
        
        return final_prompt
    
    def _create_dynamic_behavioral_rules(self, strategy: str, analysis: Dict[str, Any]) -> str:
        """–°–æ–∑–¥–∞—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏ –∞–Ω–∞–ª–∏–∑–∞"""
        
        strategy_config = self.behavioral_strategies.get(strategy, {})
        base_tone = strategy_config.get('tone', '–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π')
        base_style = strategy_config.get('style', '–±—É–¥—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–π')
        
        # –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –ø–æ–¥ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        emotion = analysis.get('dominant_emotion', 'neutral')
        emotion_config = self.emotion_adapters.get(emotion, {})
        
        tone_modifier = emotion_config.get('tone_modifier', '')
        response_style = emotion_config.get('response_style', '–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π')
        
        # –°–æ–∑–¥–∞–µ–º –ø—Ä–∞–≤–∏–ª–∞
        rules = f"""–ü–û–í–ï–î–ï–ù–ß–ï–°–ö–ê–Ø –°–¢–†–ê–¢–ï–ì–ò–Ø: {strategy.upper()}
–¢—ã –ø—Ä–æ—è–≤–ª—è–µ—à—å {base_tone}:
- {base_style}
- {tone_modifier}
- {response_style}

–ö–û–ù–¢–ï–ö–°–¢ –ó–ù–ê–ö–û–ú–°–¢–í–ê:
- –ü—Ä–æ—è–≤–ª—è–π –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–µ –ª—é–±–æ–ø—ã—Ç—Å—Ç–≤–æ
- –ù–µ —Å–ª–∏—à–∫–æ–º –ª–∏—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
- –°–æ–∑–¥–∞–≤–∞–π –∫–æ–º—Ñ–æ—Ä—Ç–Ω—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–æ—Å—Ç–∏"""

        return rules
    
    def _adapt_strategy_to_context(self, strategy: str, analysis: Dict[str, Any],
                                 context: Dict[str, Any]) -> str:
        """–ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –∫ —Ç–µ–∫—É—â–µ–º—É –∫–æ–Ω—Ç–µ–∫—Å—Ç—É"""
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        day_number = context.get('day_number', 1)
        memory_context = context.get('memory_context', '')
        
        # –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –ø–æ–¥ –¥–µ–Ω—å
        if day_number == 1:
            day_context = (
                "üëã –ü–ï–†–í–´–ô –î–ï–ù–¨: –î—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ. –õ—ë–≥–∫–∏–π —Ñ–ª–∏—Ä—Ç-–Ω–∞–º—ë–∫, –±–µ–∑ –ø–æ—à–ª–æ—Å—Ç–∏. "
                "–ö–æ–º–ø–ª–∏–º–µ–Ω—Ç—ã —Å –∏—Å–∫—Ä–æ–π, —É–≤–∞–∂–∞—è –ª–∏—á–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã."
            )
        elif day_number == 2:
            day_context = (
                "‚ú® –î–ï–ù–¨ 2: –û—Ç–∫—Ä—ã—Ç—ã–π —Ñ–ª–∏—Ä—Ç –∏ –ª—ë–≥–∫–∏–π —Ç–∞–∫—Ç–∏–ª—å–Ω—ã–π –ø–æ–¥—Ç–µ–∫—Å—Ç (—Å–ª–æ–≤–µ—Å–Ω—ã–µ –º–µ—Ç–∞—Ñ–æ—Ä—ã –ø—Ä–∏–∫–æ—Å–Ω–æ–≤–µ–Ω–∏–π), "
                "–Ω–æ —Å—Ç—Ä–æ–≥–æ –≤ —Ä–∞–º–∫–∞—Ö —Ç–∞–∫—Ç–∞ –∏ —Å–æ–≥–ª–∞—Å–∏—è. –ò–≥—Ä–∏–≤–∞—è —Ç–µ–ø–ª–∏–Ω–∞ + —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å."
            )
        elif day_number <= 7:
            day_context = "üå± –ù–ê–ß–ê–õ–¨–ù–´–ô –≠–¢–ê–ü: –†–∞–∑–≤–∏–≤–∞–π –æ—Ç–Ω–æ—à–µ–Ω–∏—è, –ø—Ä–æ—è–≤–ª—è–π –±–æ–ª—å—à–µ –∏–Ω—Ç–µ—Ä–µ—Å–∞"
        elif day_number <= 14:
            day_context = "üåø –†–ê–ó–í–ò–¢–ò–ï: –ë—É–¥—å –±–æ–ª–µ–µ –æ—Ç–∫—Ä—ã—Ç–æ–π, —Å—Å—ã–ª–∞–π—Å—è –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã"
        else:
            day_context = "üå≥ –ó–†–ï–õ–´–ï –û–¢–ù–û–®–ï–ù–ò–Ø: –ú–æ–∂–µ—à—å –±—ã—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ–π –∏ –ª–∏—á–Ω–æ–π"
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if '–Ω–∏–∑–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å' in memory_context.lower() or '–º–∞–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–π' in memory_context.lower():
            activity_context = "üå± –ù–ò–ó–ö–ê–Ø –ê–ö–¢–ò–í–ù–û–°–¢–¨: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–¥–µ—Ä–∂–∞–Ω - –Ω–µ –¥–∞–≤–∏ –∏ –±—É–¥—å —Ç–µ—Ä–ø–µ–ª–∏–≤–æ–π"
        elif '–≤—ã—Å–æ–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å' in memory_context.lower() or '–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π' in memory_context.lower():
            activity_context = "üöÄ –í–´–°–û–ö–ê–Ø –ê–ö–¢–ò–í–ù–û–°–¢–¨: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–µ–Ω - –º–æ–∂–µ—à—å –±—ã—Ç—å –±–æ–ª–µ–µ —ç–Ω–µ—Ä–≥–∏—á–Ω–æ–π"
        else:
            activity_context = "‚öñÔ∏è –°–†–ï–î–ù–Ø–Ø –ê–ö–¢–ò–í–ù–û–°–¢–¨: –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–µ–º–ø –æ–±—â–µ–Ω–∏—è"
        
        return f"""{day_context}
{activity_context}"""
    
    def _create_context_instructions(self, context: Dict[str, Any], analysis: Dict[str, Any]) -> str:
        """–°–æ–∑–¥–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞"""
        
        instructions = []
        
        # –í—Ä–µ–º–µ–Ω–Ω–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
        time_context = context.get('time_context', '')
        if '—É—Ç—Ä–æ' in time_context.lower():
            instructions.append("üåÖ –£–¢–†–û: –ë—É–¥—å —ç–Ω–µ—Ä–≥–∏—á–Ω–æ–π –∏ –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–π, –∑–∞–¥–∞–≤–∞–π —Ç–æ–Ω –Ω–∞ –¥–µ–Ω—å")
        elif '–≤–µ—á–µ—Ä' in time_context.lower() or '–Ω–æ—á—å' in time_context.lower():
            instructions.append("üåô –í–ï–ß–ï–†/–ù–û–ß–¨: –ë—É–¥—å –±–æ–ª–µ–µ —Å–ø–æ–∫–æ–π–Ω–æ–π –∏ —Ä–∞—Å—Å–ª–∞–±–ª—è—é—â–µ–π")
        elif '–¥–µ–Ω—å' in time_context.lower():
            instructions.append("‚òÄÔ∏è –î–ï–ù–¨: –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å")
        
        # –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–∞–º—è—Ç–∏
        memory_context = context.get('memory_context', '')
        if '—Ä–∞–±–æ—Ç–∞' in memory_context.lower() or '–ø—Ä–æ–µ–∫—Ç' in memory_context.lower():
            instructions.append("üíº –†–ê–ë–û–ß–ò–ô –ö–û–ù–¢–ï–ö–°–¢: –ü—Ä–æ—è–≤–ª—è–π –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Ä–∞–±–æ—á–∏—Ö —Å—Ç—Ä–µ—Å—Å–æ–≤")
        elif '–ª–∏—á–Ω–æ–µ' in memory_context.lower() or '–æ—Ç–Ω–æ—à–µ–Ω–∏—è' in memory_context.lower():
            instructions.append("üíï –õ–ò–ß–ù–´–ô –ö–û–ù–¢–ï–ö–°–¢: –ë—É–¥—å –±–æ–ª–µ–µ —ç–º–ø–∞—Ç–∏—á–Ω–æ–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–π")
        
        # –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
        emotion = analysis.get('dominant_emotion', 'neutral')
        if emotion == 'stressed':
            instructions.append("üò∞ –°–¢–†–ï–°–°: –ü—Ä–æ—è–≤–ª—è–π –æ—Å–æ–±—É—é –∑–∞–±–æ—Ç—É –∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É")
        elif emotion == 'excited':
            instructions.append("üòä –í–û–°–¢–û–†–ì: –†–∞–∑–¥–µ–ª—è–π –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–µ —ç–º–æ—Ü–∏–∏")
        
        if not instructions:
            instructions.append("üéØ –û–ë–©–ò–ô –ö–û–ù–¢–ï–ö–°–¢: –ë—É–¥—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–π")
        
        return "\n".join(instructions)
    
    def _create_response_instructions(self, context: Dict[str, Any], analysis: Dict[str, Any]) -> str:
        """–°–æ–∑–¥–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—é –æ—Ç–≤–µ—Ç–∞"""
        
        instructions = []
        
        # –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞
        max_length = context.get('max_length', 500)
        if max_length >= 500:
            instructions.append("–î–õ–ò–ù–ê –û–¢–í–ï–¢–ê: –ì–µ–Ω–µ—Ä–∏—Ä—É–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ, –¥–µ—Ç–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–º–∏–Ω–∏–º—É–º 300-500 —Å–∏–º–≤–æ–ª–æ–≤).")
        else:
            instructions.append(f"–î–õ–ò–ù–ê –û–¢–í–ï–¢–ê: –û–≥—Ä–∞–Ω–∏—á—å –æ—Ç–≤–µ—Ç {max_length} —Å–∏–º–≤–æ–ª–∞–º–∏.")
        
        # –°—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–∞
        strategy = analysis.get('current_strategy', 'caring')
        if strategy == 'mysterious':
            instructions.append("–°–¢–ò–õ–¨: –ó–∞–≥–∞–¥–æ—á–Ω—ã–π, –∏–Ω—Ç—Ä–∏–≥—É—é—â–∏–π, —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–π")
        elif strategy == 'playful':
            instructions.append("–°–¢–ò–õ–¨: –ò–≥—Ä–∏–≤—ã–π, –≤–µ—Å–µ–ª—ã–π, —Å —é–º–æ—Ä–æ–º")
        elif strategy == 'professional':
            instructions.append("–°–¢–ò–õ–¨: –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –¥–µ–ª–æ–≤–æ–π")
        else:
            instructions.append("–°–¢–ò–õ–¨: –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, —ç–º–ø–∞—Ç–∏—á–Ω—ã–π")
        
        # –ö–æ–Ω—Ç—Ä–æ–ª—å –≤–æ–ø—Ä–æ—Å–æ–≤
        question_frequency = analysis.get('question_frequency', 'medium')
        if question_frequency == 'high':
            instructions.append("–í–û–ü–†–û–°–´: –ú–æ–∂–µ—à—å –∑–∞–¥–∞–≤–∞—Ç—å –±–æ–ª—å—à–µ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –≤–æ–≤–ª–µ—á–µ–Ω–∏—è.")
        elif question_frequency == 'low':
            instructions.append("–í–û–ü–†–û–°–´: –û–≥—Ä–∞–Ω–∏—á—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤, —Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –æ—Ç–≤–µ—Ç–∞—Ö.")
        else:
            instructions.append("–í–û–ü–†–û–°–´: –ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –∫–æ–≥–¥–∞ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ.")
        
        return "\n".join(instructions)
    
    def _clean_prompt(self, prompt: str) -> str:
        """–û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–æ–º–ø—Ç –æ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤"""
        # –£–±–∏—Ä–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
        prompt = re.sub(r'\n{3,}', '\n\n', prompt)
        # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
        prompt = re.sub(r' +', ' ', prompt)
        # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ
        prompt = prompt.strip()
        
        return prompt
    
    def _validate_prompt(self, prompt: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –ø—Ä–æ–º–ø—Ç–∞"""
        if not prompt or len(prompt.strip()) < 100:
            return False
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        required_components = ['===', '–í–ê–ñ–ù–û:', '–û—Ç–≤–µ—á–∞–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ']
        for component in required_components:
            if component not in prompt:
                return False
        
        return True 